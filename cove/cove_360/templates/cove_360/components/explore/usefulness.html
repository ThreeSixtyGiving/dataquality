{% load i18n %}
{% load humanize %}
{% load cove_tags %}

<h2>Usefulness Opportunities</h2>

  {% if validation_and_closed_codelist_errors_count > 0 %}
  <p><strong>Caution:</strong> The data provided did <a href="#validity">not pass validation</a>, therefore the usefulness of the data could not be fully determined.</a>

  {% elif usefulness_checks_count == 0 %}
  <p><i class="material-icons table--true">check</i>Congratulations! Your data includes {{total_usefulness_checks}} key features that make 360Giving data useful. Learn more about <a href="{% url 'additional_checks' %}">how we assess usefulness</a>.</p>
  {% endif %}

  {% if usefulness_checks_errored %}
    <p>{% blocktrans %}Some Usefulness checks failed due to an issue with the data.{% endblocktrans %}</p>
  {% endif %}



  {% if usefulness_checks_count %}

      <p>Your data was checked for {{total_usefulness_checks}} key features that make 360Giving data useful. Learn more about <a href="{% url 'additional_checks' %}">how we assess usefulness</a>.</p>

      <p>{% blocktrans %}Use the feedback below to find and review the opportunities to improve the usefulness of the data in your file. Note that receiving this feedback does not mean the data is invalid so it may be ignored when not relevant.{% endblocktrans %}</p>

      {% for category in usefulness_categories %}
      <h4>{{category}}</h4>

      <table class="table">
      <thead>
        <tr>
          <th>{% trans 'Failed' %}</th>
          <th>{% trans 'Check Description' %} </th>
          <th>{% trans 'First 3 Locations' %}</th>
        </tr>
      </thead>
      <tbody>
      {% for message, json_location, spreadsheet_location in usefulness_checks %}
      {% if message.category == category %}
      <tr>
          <td>
            {# graph of how many grants affected experimental #}
            <div style="border-radius: 3px; background-color: hsl(var(--teal-dark-hsl), 1); width:100%; height:20px; min-width:90px">
              <div style="border-radius: 3px; background-color: hsl(var(--red-hsl), 1); height: 20px; width: {{message.percentage|multiply:100}}%; min-width:5px;">
                <span style="color: white;" class="margin-left:1">{{message.percentage|multiply:100}}%</span>
              </div>
            </div>
          </td>
          <td>
            <strong>{{ message.heading }}</strong><br /><br />{{ message.message }}
          </td>
          {# first 3 locations #}
        {% if file_type == 'xlsx' or file_type == 'csv' %}
          <td>
            <ul class="list-unstyled">
              {% for location in spreadsheet_location|slice:":3" %}
              <li> <b>Sheet:</b> {{location.sheet}} <b>Row:</b> {{location.row_number}} {% if location.header %} <b>Header:</b> {{location.header}} {% endif %} </li>
              {% endfor %}
              {% if spreadsheet_location|length > 3 %}
                <li><button class="button button--small" data-toggle="modal" data-target-class="{{"usefulness-checks-"|concat:forloop.counter}}">see all</button></li>
              {% endif %}
            </ul>
          </td>
        {% else %}
          <td>
            <ul class="list-unstyled">
              {% for location in json_location|slice:":3" %}
                  <li>{{location}}</li>
              {% endfor %}
              {% if json_location|length > 3 %}
                <li><button class="button button--small" data-toggle="modal"  data-target-class="{{"usefulness-checks-"|concat:forloop.counter}}">see all</button></li>
              {% endif %}
            </ul>
          </td>
        {% endif %}
      </tr>
      {% endif %} {# end category filter #}
      {% endfor %}
      </tbody>
      </table>
      {% endfor %} {# categories #}

    {% endif %} {# if count #}

    {% for message, json_location, spreadsheet_location in usefulness_checks %}
      {% with msg=message.heading %}
        {% if file_type == 'json' %}
          {% cove_360_modal_errors className="usefulness-checks-"|concat:forloop.counter modalTitle=msg errorList=json_location file_type=file_type full_table=False %}
        {% else %}
          {% cove_360_modal_errors className="usefulness-checks-"|concat:forloop.counter modalTitle=msg errorList=spreadsheet_location file_type=file_type full_table=False %}
        {% endif %}
      {% endwith %}
    {% endfor %}